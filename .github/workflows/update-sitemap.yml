name: Auto Update Sitemap (Axonexus)

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.html'
      - 'sitemap.xml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update <lastmod> in sitemap.xml (UTC)
        run: |
          set -e
          if [ ! -f sitemap.xml ]; then
            echo "‚ùå sitemap.xml no existe en la ra√≠z del repo"
            exit 1
          fi
          TODAY="$(date -u +'%Y-%m-%d')"
          sed -i "s|<lastmod>[^<]*</lastmod>|<lastmod>${TODAY}</lastmod>|g" sitemap.xml
          echo "‚úÖ sitemap.xml actualizado con fecha ${TODAY}"

      - name: Commit updated sitemap
        id: commit
        run: |
          set -e
          git config user.name "AxonexusBot"
          git config user.email "actions@axonexus.net"
          if git diff --quiet sitemap.xml; then
            echo "‚ö™ No hay cambios que commitear."
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            git add sitemap.xml
            git commit -m "chore: auto-update sitemap lastmod [skip ci]"
            git push
            echo "‚úÖ Cambios pusheados."
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      - name: Notify search engines (Google & Bing)
        if: steps.commit.outputs.pushed == 'true'
        run: |
          # Reintentos por si el hosting tarda unos segundos en publicar
          for i in {1..5}; do
            curl -fsS "https://www.google.com/ping?sitemap=https://axonexus.net/sitemap.xml" && break || sleep 5
          done
          for i in {1..5}; do
            curl -fsS "https://www.bing.com/ping?sitemap=https://axonexus.net/sitemap.xml" && break || sleep 5
          done
          echo "üì° Notificaci√≥n enviada a Google y Bing."
