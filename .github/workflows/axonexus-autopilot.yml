name: Axonexus Autopilot

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.html'
      - 'sitemap.xml'
      - 'robots.txt'
      - 'scripts/**'
  schedule:
    - cron: '0 */6 * * *'   # cada 6 horas (UTC)
  workflow_dispatch:

jobs:
  autopilot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python for sitemap (if needed)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Ensure bash perms
        run: |
          chmod +x scripts/*.sh || true

      - name: Inject imperial footer into all HTML
        run: |
          bash scripts/inject_footer.sh

      - name: Update / regenerate sitemap
        env:
          TZ: UTC
        run: |
          bash scripts/update_sitemap.sh

      - name: Commit & push changes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "AxonexusBot"
          git config user.email "actions@axonexus.net"
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore(autopilot): inject footer + refresh sitemap [ci]"
            git push
          else
            echo "Sin cambios que commitear."
          fi

      - name: Ping search engines
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }} # opcional
        run: |
          bash scripts/ping_search.sh

